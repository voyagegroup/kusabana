#!/usr/bin/env ruby
# coding: UTF-8
lib = File.expand_path(File.dirname(__FILE__) + '/../lib')
$LOAD_PATH.unshift(lib) if File.directory?(lib) && !$LOAD_PATH.include?(lib)

require 'memcached'
require 'em-proxy'
require 'uuid'
require 'http/parser'
require 'kusabana'
require 'yaml'

config = YAML.load_file("config.yml")

rules = []
rules << Kusabana::Rule.new('POST', /\/\S+\/_search(\?.+)?/, 60) do |query|
  begin
    query['facets']['terms']['facet_filter']['fquery']['query']['filtered']['filter']['bool']['must'].each do |filter|
      if range = filter.fetch('range', nil)
        if timestamp = range.fetch('@timestamp', nil)
          timestamp['from'] = timestamp['from'] / 100 * 100
          timestamp['to'] = timestamp['to'] / 100 * 100
        end
      end
    end
  rescue NoMethodError
  end

  begin
    query['query']['filtered']['filter']['bool']['must'].each do |filter|
      if range = filter.fetch('range', nil)
        if timestamp = range.fetch('@timestamp', nil)
          timestamp['from'] = timestamp['from'] / 100 * 100
          timestamp['to'] = timestamp['to'] / 100 * 100
        end
      end
    end
  rescue NoMethodError
  end

  query
end

rules << Kusabana::Rule.new('GET', /\/_nodes/, 60)

Kusabana::Proxy.new(rules, config).start
